<!DOCTYPE html>
<html>
<head>
    <title>Technical Control Panel</title>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        :root { --sidebar-bg: #1c1c1c; --accent: #00ffcc; --dark-card: #252525; --text-color: #e0e0e0; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; background: #0a0a0a; color: var(--text-color); overflow: hidden; }
        
        /* SIDEBAR */
        .sidebar { width: 250px; background: var(--sidebar-bg); height: 100vh; position: fixed; border-right: 1px solid #333; z-index: 1001; }
        .sidebar-header { padding: 25px; background: #111; color: var(--accent); font-weight: bold; font-size: 1.2rem; letter-spacing: 2px; border-bottom: 1px solid #333; }
        .nav-item { padding: 18px 25px; cursor: pointer; border-bottom: 1px solid #222; transition: 0.3s; color: #888; }
        .nav-item:hover, .nav-item.active { background: #252525; color: var(--accent); border-left: 4px solid var(--accent); }

        /* FIXED TECHNICAL GPS HEADER */
        .fixed-header {
            position: fixed; top: 0; left: 250px; right: 0; height: 90px;
            background: #111; border-bottom: 1px solid #333;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 30px; z-index: 1000; font-family: 'Courier New', monospace;
        }
        .gps-display { line-height: 1.2; }
        .gps-address { color: var(--accent); font-size: 0.95rem; font-weight: bold; }
        .gps-meta { color: #666; font-size: 0.8rem; margin-top: 5px; }

        /* BATTERY & STATUS */
        .status-group { display: flex; align-items: center; gap: 20px; }
        .bat-box { padding: 5px 15px; border-radius: 3px; font-weight: bold; background: #222; border: 1px solid #444; }
        .online { color: #00ff00; border-color: #00ff00; }
        .offline { color: #ff3333; border-color: #ff3333; }
        .bat-icon-stack { position: relative; font-size: 2rem; display: flex; align-items: center; }
        #bolt { position: absolute; color: #f1c40f; font-size: 1.2rem; left: 8px; text-shadow: 0 0 5px black; display: none; }

        /* CONTENT VIEWS */
        .main-content { margin-left: 250px; padding-top: 90px; flex: 1; height: 100vh; overflow-y: auto; }
        .view { display: none; padding: 30px; height: calc(100vh - 150px); }
        .view.active { display: block; }

        /* MAP STYLING */
        #map { width: 100%; height: 400px; border-radius: 8px; border: 1px solid #333; margin-top: 15px; background: #1a1a1a; }

        /* TABULAR SMS */
        table { width: 100%; border-collapse: collapse; background: #151515; border: 1px solid #333; }
        th { background: #222; color: var(--accent); padding: 15px; text-align: left; font-size: 0.8rem; text-transform: uppercase; }
        td { padding: 12px 15px; border-bottom: 1px solid #222; font-size: 0.9rem; }
        .Incoming { color: #00ff88; }
        .Outgoing { color: #00ccff; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="sidebar-header">SYSTEM_CORE v2</div>
    <div class="nav-item active" onclick="showView('dash')">üìä TERMINAL</div>
    <div class="nav-item" onclick="showView('sms')">‚úâÔ∏è SMS_DATA</div>
    <div class="nav-item" onclick="showView('map-view')">üìç LIVE_MAP</div>
</div>

<div class="fixed-header">
    <div class="gps-display">
        <div id="gps-addr" class="gps-address">SYNCING GPS SATELLITES...</div>
        <div class="gps-meta">
            ACCURACY: <span id="gps-acc">--</span> M | LAST_FIX: <span id="gps-time">--</span>
        </div>
    </div>
    <div class="status-group">
        <div id="status-box" class="bat-box offline">DEVICE_OFFLINE</div>
        <div style="font-size: 1.8rem; color: var(--accent);"><span id="pct">--</span>%</div>
        <div class="bat-icon-stack"><span>üîã</span><span id="bolt">‚ö°</span></div>
    </div>
</div>

<div class="main-content">
    <div id="dash" class="view active">
        <h2>System Status</h2>
        <p>Telemetry stream active. All systems nominal.</p>
    </div>

    <div id="map-view" class="view">
        <h2>Geospatial Intelligence</h2>
        <div id="map"></div>
    </div>

    <div id="sms" class="view">
        <h2>Communication Logs</h2>
        <table>
            <thead><tr><th>TYPE</th><th>SOURCE/DEST</th><th>CONTENT</th><th>TIMESTAMP</th></tr></thead>
            <tbody id="sms-table"></tbody>
        </table>
    </div>
</div>

<script>
    const socket = io();
    let map, marker;

    // Initialize Map
    function initMap() {
        if (!map) {
            map = L.map('map').setView([0, 0], 2);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap'
            }).addTo(map);
            marker = L.marker([0, 0]).addTo(map);
        }
    }

    function showView(id) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(id === 'map-view') {
            setTimeout(() => { initMap(); map.invalidateSize(); }, 200);
        }
        if(id === 'sms') socket.emit('get-sms-request');
    }

    socket.on('ui-battery', (data) => {
        document.getElementById('pct').innerText = data.percent;
        document.getElementById('status-box').innerText = "DEVICE_ONLINE";
        document.getElementById('status-box').className = "bat-box online";
        document.getElementById('bolt').style.display = data.charging ? "block" : "none";
    });

    socket.on('ui-gps-display', (data) => {
        document.getElementById('gps-addr').innerText = data.address;
        document.getElementById('gps-acc').innerText = data.accuracy;
        document.getElementById('gps-time').innerText = data.time;

        // Update Map Marker
        if (data.lat && data.lng) {
            const pos = [data.lat, data.lng];
            if (map) {
                map.setView(pos, 15);
                marker.setLatLng(pos);
            }
        }
    });

    socket.on('ui-sms-display', (data) => {
        const html = data.map(m => `<tr><td class="${m.type}">${m.type}</td><td><b>${m.address}</b></td><td>${m.body}</td><td style="color:#666;">${new Date(m.date).toLocaleString()}</td></tr>`).join('');
        document.getElementById('sms-table').innerHTML = html;
    });

    socket.on('device-status', (s) => { 
        if(!s.online) {
            document.getElementById('status-box').innerText = "DEVICE_OFFLINE";
            document.getElementById('status-box').className = "bat-box offline";
        }
    });
</script>
</body>
</html>
